<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® MaestroFin Crisis Sensor - Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.0/index.min.js"></script>
    <link rel="stylesheet" href="/static/dashboard_cyberpunk.css">
</head>
<body>
    <!-- Header Cyberpunk -->
    <div class="header">
        <h1>üö® MAESTROFIN CRISIS SENSOR</h1>
        <div class="status-indicator">
            <div class="status-dot"></div>
            <span>SISTEMA ATIVO ‚Ä¢ √öLTIMA VARREDURA: <span id="lastUpdate">--</span></span>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="container">
        <!-- Tabs de Navega√ß√£o -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('overview')">üìä OVERVIEW</button>
            <button class="tab-button" onclick="showTab('users')">üë• USU√ÅRIOS</button>
            <button class="tab-button" onclick="showTab('commands')">‚ö° COMANDOS</button>
            <button class="tab-button" onclick="showTab('performance')">üöÄ PERFORMANCE</button>
            <button class="tab-button" onclick="showTab('errors')">üö® ALERTAS</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <!-- M√©tricas em Tempo Real -->
            <div class="metrics-grid" id="realtimeMetrics">
                <div class="status-card">
                    <div class="spinner"></div>
                    INICIALIZANDO SENSORES...
                </div>
            </div>
            
            <!-- Gr√°ficos Principais -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">üìà ATIVIDADE SISTEMA - 24H</h3>
                    <div class="chart-container">
                        <canvas id="activityChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title">üèÜ COMANDOS CR√çTICOS</h3>
                    <div class="chart-container">
                        <canvas id="commandsChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title">‚ö° LAT√äNCIA SISTEMA</h3>
                    <div class="chart-container">
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title">üë§ USU√ÅRIOS EM ALERTA</h3>
                    <div class="user-activity" id="topUsers">
                        <div class="status-card">ESCANEANDO USU√ÅRIOS...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">üë• USU√ÅRIOS MONITORADOS</h3>
                    <div class="tabs">
                        <button class="tab-button active" onclick="loadActiveUsers('24h')">24H</button>
                        <button class="tab-button" onclick="loadActiveUsers('7d')">7 DIAS</button>
                        <button class="tab-button" onclick="loadActiveUsers('30d')">30 DIAS</button>
                    </div>
                    <div id="activeUsersContent">
                        <div class="status-card">CARREGANDO DADOS...</div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title">üìä DISTRIBUI√á√ÉO DE USU√ÅRIOS</h3>
                    <div class="chart-container">
                        <canvas id="userDistributionChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commands Tab -->
        <div id="commands" class="tab-content">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">‚ö° AN√ÅLISE DE COMANDOS</h3>
                    <div id="commandsContent">
                        <div class="status-card">PROCESSANDO COMANDOS...</div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title">üìà TEND√äNCIAS DE COMANDOS</h3>
                    <div class="chart-container">
                        <canvas id="commandTrendsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Tab -->
        <div id="performance" class="tab-content">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">üöÄ PERFORMANCE POR COMANDO</h3>
                    <div id="performanceContent">
                        <div class="status-card">ANALISANDO PERFORMANCE...</div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title">‚è±Ô∏è TIMELINE DE PERFORMANCE</h3>
                    <div class="chart-container">
                        <canvas id="performanceTimelineChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Errors Tab -->
        <div id="errors" class="tab-content">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">üö® AN√ÅLISE DE ALERTAS</h3>
                    <div id="errorsContent">
                        <div class="status-card">VERIFICANDO ALERTAS...</div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title">üìä ALERTAS POR COMANDO</h3>
                    <div class="chart-container">
                        <canvas id="errorsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>MaestroFin Analytics Dashboard ‚Ä¢ Atualiza√ß√£o autom√°tica a cada 30 segundos</p>
    </div>

    <!-- JavaScript -->
    <script>
        // Configura√ß√£o global dos gr√°ficos
        Chart.defaults.color = '#00ffff';
        Chart.defaults.borderColor = 'rgba(0, 255, 255, 0.2)';
        Chart.defaults.backgroundColor = 'rgba(0, 255, 255, 0.1)';

        // Estado atual da aplica√ß√£o
        let currentTab = 'overview';
        let charts = {};

        // üö® CORRE√á√ÉO URGENTE - Tabs clic√°veis funcionais
        function showTab(tabName) {
            console.log('üîÑ Mudando para tab:', tabName); // Debug
            
            // Ocultar todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active dos bot√µes
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
                console.log('‚úÖ Tab ativada:', tabName);
            } else {
                console.error('‚ùå Tab n√£o encontrada:', tabName);
            }
            
            // Ativar bot√£o clicado - Melhorada detec√ß√£o
            const activeButton = document.querySelector(`button[onclick*="showTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                console.log('‚úÖ Bot√£o ativado');
            }
            
            currentTab = tabName;
            loadTabData(tabName);
        }

        // üî• EVENTO DE CLIQUE DIRETO - Backup para garantir funcionamento
        document.addEventListener('DOMContentLoaded', function() {
            // Adicionar eventos de clique diretamente nos bot√µes
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach((button, index) => {
                const tabNames = ['overview', 'users', 'commands', 'performance', 'errors'];
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('üéØ Clique direto detectado:', tabNames[index]);
                    showTab(tabNames[index]);
                });
            });
            
            console.log('‚úÖ Event listeners adicionados a', tabButtons.length, 'bot√µes');
        });

        // Fun√ß√£o para carregar usu√°rios ativos por per√≠odo
        async function loadActiveUsers(period) {
            try {
                const response = await fetch(`/api/users/active?period=${period}`);
                const data = await response.json();
                
                const content = document.getElementById('activeUsersContent');
                if (data.users && data.users.length > 0) {
                    content.innerHTML = `
                        <div class="metric-header">
                            <span>Total: ${data.total_active_users} usu√°rios ativos (${period})</span>
                        </div>
                        ${data.users.slice(0, 10).map(user => `
                            <div class="status-card">
                                <div class="metric-value">${user.username || 'Usu√°rio'}</div>
                                <div class="metric-label">${user.commands_count} comandos ‚Ä¢ √öltimo: ${new Date(user.last_activity).toLocaleString('pt-BR')}</div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    content.innerHTML = '<div class="status-card">NENHUM USU√ÅRIO ATIVO NO PER√çODO</div>';
                }
                
                // Atualizar bot√µes ativos
                document.querySelectorAll('#users .tab-button').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                document.getElementById('activeUsersContent').innerHTML = 
                    '<div class="status-card">ERRO AO CARREGAR DADOS</div>';
            }
        }
        function loadTabData(tabName) {
            switch(tabName) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'users':
                    loadUsersData();
                    break;
                case 'commands':
                    loadCommandsData();
                    break;
                case 'performance':
                    loadPerformanceData();
                    break;
                case 'errors':
                    loadErrorsData();
                    break;
            }
        }

        // Carregar dados do overview
        async function loadOverviewData() {
            try {
                const response = await fetch('/api/realtime');
                const data = await response.json();
                // Compat: se vier nested usa, sen√£o usa objeto direto
                const stats = data.realtime_stats || data;
                updateMetrics(stats);
                updateCharts(data);
                updateLastUpdate();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // Atualizar m√©tricas
        function updateMetrics(stats) {
            const metricsGrid = document.getElementById('realtimeMetrics');
            if (!stats) return;

            metricsGrid.innerHTML = `
                <div class="status-card">
                    <div class="metric-value">${stats.total_users || 0}</div>
                    <div class="metric-label">USU√ÅRIOS ATIVOS</div>
                </div>
                <div class="status-card">
                    <div class="metric-value">${stats.total_commands || 0}</div>
                    <div class="metric-label">COMANDOS EXECUTADOS</div>
                </div>
                <div class="status-card">
                    <div class="metric-value">${stats.avg_response_time || 0}ms</div>
                    <div class="metric-label">TEMPO RESPOSTA</div>
                </div>
                <div class="status-card">
                    <div class="metric-value">${stats.error_count || 0}</div>
                    <div class="metric-label">ALERTAS DETECTADOS</div>
                </div>
            `;
        }

        // Atualizar timestamp
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                now.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
        }

        // Carregar dados dos usu√°rios
        async function loadUsersData() {
            try {
                const response = await fetch('/api/users/active?period=24h');
                const data = await response.json();
                const content = document.getElementById('activeUsersContent');
                const users = data.users || [];
                if (users.length > 0) {
                    content.innerHTML = users.map(user => `
                        <div class="status-card">
                            <div class="metric-value">${user.username || 'Usu√°rio'}</div>
                            <div class="metric-label">${user.commands_count} comandos</div>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<div class="status-card">NENHUM USU√ÅRIO ATIVO</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                document.getElementById('activeUsersContent').innerHTML = '<div class="status-card">ERRO AO CARREGAR</div>';
            }
        }

        // Carregar dados dos comandos
        async function loadCommandsData() {
            try {
                const response = await fetch('/api/commands/ranking?days=7');
                const data = await response.json();
                const content = document.getElementById('commandsContent');
                const ranking = data.ranking || [];
                if (ranking.length > 0) {
                    content.innerHTML = ranking.map(cmd => `
                        <div class="status-card">
                            <div class="metric-value">${cmd.command}</div>
                            <div class="metric-label">${cmd.count || cmd.total_uses || 0} usos</div>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<div class="status-card">NENHUM COMANDO REGISTRADO</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar comandos:', error);
                document.getElementById('commandsContent').innerHTML = '<div class="status-card">ERRO AO CARREGAR</div>';
            }
        }

        // Carregar dados de performance
        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/performance/metrics?hours=24');
                const data = await response.json();
                const content = document.getElementById('performanceContent');
                const perf = data.metrics || {};
                content.innerHTML = `
                    <div class="status-card">
                        <div class="metric-value">AVG ${perf.response_times ? perf.response_times.avg_ms : 0}ms</div>
                        <div class="metric-label">P95 ${(perf.response_times && perf.response_times.p95_ms) || 0}ms ‚Ä¢ Max ${(perf.response_times && perf.response_times.max_ms) || 0}ms</div>
                    </div>
                    <div class="status-card">
                        <div class="metric-value">Throughput ${(perf.throughput && perf.throughput.requests_per_hour) || 0}/h</div>
                        <div class="metric-label">Comandos ${(perf.throughput && perf.throughput.commands_per_hour) || 0}/h</div>
                    </div>`;
            } catch (error) {
                console.error('Erro ao carregar performance:', error);
                document.getElementById('performanceContent').innerHTML = '<div class="status-card">ERRO AO CARREGAR</div>';
            }
        }

        // Carregar dados de erros
        async function loadErrorsData() {
            try {
                const response = await fetch('/api/errors/detailed?days=7');
                const data = await response.json();
                const content = document.getElementById('errorsContent');
                const errors = data.errors || [];
                if (errors.length > 0) {
                    content.innerHTML = errors.map(err => `
                        <div class="status-card">
                            <div class="metric-value">${err.error_type}</div>
                            <div class="metric-label">${(err.message || '').slice(0,40)}...</div>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<div class="status-card">NENHUM ALERTA DETECTADO ‚úÖ</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
                document.getElementById('errorsContent').innerHTML = '<div class="status-card">ERRO AO CARREGAR</div>';
            }
        }

        // Atualizar gr√°ficos
        function updateCharts(data) {
            // Implementar atualiza√ß√£o dos gr√°ficos
        }

        // Inicializar dashboard
        function initDashboard() {
            loadOverviewData();
            
            // Atualizar a cada 30 segundos
            setInterval(() => {
                if (currentTab === 'overview') {
                    loadOverviewData();
                }
            }, 30000);
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
