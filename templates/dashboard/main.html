<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro - MaestroFin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="{{ url_for('static', filename='dashboard.css') }}" rel="stylesheet">
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line"></i> MaestroFin Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#transacoes"><i class="fas fa-list"></i> Transações</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#graficos"><i class="fas fa-chart-bar"></i> Gráficos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#metas"><i class="fas fa-bullseye"></i> Metas</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="periodoDropdown" role="button"
                            data-bs-toggle="dropdown">
                            <i class="fas fa-calendar"></i> {{ mes|default(now.now().month) }}/{{ ano|default(now.now().year) }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item"
                                    href="?mes={{ (mes|default(now.now().month))-1 if (mes|default(now.now().month)) > 1 else 12 }}&ano={{ ano|default(now.now().year) if (mes|default(now.now().month)) > 1 else (ano|default(now.now().year))-1 }}">Mês
                                    Anterior</a></li>
                            <li><a class="dropdown-item"
                                    href="?mes={{ (mes|default(now.now().month))+1 if (mes|default(now.now().month)) < 12 else 1 }}&ano={{ ano|default(now.now().year) if (mes|default(now.now().month)) < 12 else (ano|default(now.now().year))+1 }}">Próximo
                                    Mês</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="?mes={{ now.now().month }}&ano={{ now.now().year }}">Mês
                                    Atual</a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="atualizarDados()">
                            <i class="fas fa-sync" id="refresh-icon"></i> Atualizar
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- HEADER COM KPIs -->
    <div class="container-fluid py-4 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4">
                        <i class="fas fa-user-circle"></i> Dashboard Financeiro
<small class="text-muted">{{ mes|default(now.now().month) }}/{{ ano|default(now.now().year) }}</small>
                    </h2>
                </div>
            </div>

            <!-- KPIs Cards -->
            <div class="row g-3" id="kpis-container">
                <div class="col-md-3">
                    <div class="card kpi-card receita-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">Receitas</h6>
                                    <h4 class="card-title text-success" id="receita-total">R$ {{
                                        "%.2f"|format(kpis.receita_total|default(0)) }}</h4>
                                    <small class="text-muted">{{ kpis.qtd_transacoes|default(0) }} transações</small>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card kpi-card despesa-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">Despesas</h6>
                                    <h4 class="card-title text-danger" id="despesa-total">R$ {{
                                        "%.2f"|format(kpis.despesa_total|default(0)) }}</h4>
                                    <small class="text-muted">R$ {{ "%.2f"|format(kpis.gasto_medio_dia|default(0))
                                        }}/dia</small>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card kpi-card saldo-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">Saldo</h6>
                                    <h4 class="card-title {% if (kpis.saldo_mes|default(0)) >= 0 %}text-success{% else %}text-danger{% endif %}"
                                        id="saldo-mes">R$ {{ "%.2f"|format(kpis.saldo_mes|default(0)) }}</h4>
                                    <small class="text-muted">
                                        {% if (kpis.saldo_mes|default(0)) >= 0 %}Positivo{% else %}Negativo{% endif %}
                                    </small>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-wallet"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card kpi-card poupanca-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">Taxa Poupança</h6>
                                    <h4 class="card-title text-info" id="taxa-poupanca">{{
                                        "%.1f"|format(kpis.taxa_poupanca|default(0)) }}%</h4>
                                    <small class="text-muted">Meta: 20%</small>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-piggy-bank"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL -->
    <div class="container my-4">
        <!-- GRÁFICOS -->
        <section id="graficos" class="mb-5">
            <h3 class="mb-4"><i class="fas fa-chart-bar"></i> Análise Visual</h3>
            <div class="row">
                <!-- Gráfico de Pizza -->
                <div class="col-lg-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie"></i> Despesas por Categoria
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="grafico-pizza" class="chart-container"></div>
                            <div class="loading-spinner text-center" style="display: none;">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p>Carregando gráfico...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Evolução -->
                <div class="col-lg-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-line"></i> Evolução Mensal
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="grafico-evolucao" class="chart-container"></div>
                            <div class="loading-spinner text-center" style="display: none;">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p>Carregando gráfico...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Barras -->
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-bar"></i> Ranking de Gastos
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="grafico-barras" class="chart-container"></div>
                            <div class="loading-spinner text-center" style="display: none;">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p>Carregando gráfico...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TRANSAÇÕES RECENTES -->
        <section id="transacoes" class="mb-5">
            <h3 class="mb-4"><i class="fas fa-list"></i> Transações Recentes</h3>
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Últimas Movimentações</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="filtrarTransacoes('todas')">
                                Todas
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm"
                                onclick="filtrarTransacoes('Entrada')">
                                Receitas
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm"
                                onclick="filtrarTransacoes('Saída')">
                                Despesas
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="tabela-transacoes">
                        {% if dados.lancamentos %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrição</th>
                                        <th>Categoria</th>
                                        <th>Tipo</th>
                                        <th class="text-end">Valor</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-transacoes">
                                    {% for lancamento in dados.lancamentos[:20] %}
                                    <tr class="transacao-row" data-tipo="{{ lancamento.tipo }}">
                                        <td>{{ lancamento.data_transacao.strftime('%d/%m') if lancamento.data_transacao
                                            else 'N/A' }}</td>
                                        <td>
                                            <strong>{{ lancamento.descricao }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ lancamento.categoria_nome or 'Sem
                                                categoria' }}</span>
                                        </td>
                                        <td>
                                            {% if lancamento.tipo == 'Entrada' %}
                                            <span class="badge bg-success">Receita</span>
                                            {% else %}
                                            <span class="badge bg-danger">Despesa</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <strong
                                                class="{% if lancamento.tipo == 'Entrada' %}text-success{% else %}text-danger{% endif %}">
                                                R$ {{ "%.2f"|format(lancamento.valor) }}
                                            </strong>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5>Nenhuma transação encontrada</h5>
                            <p class="text-muted">Não há movimentações para o período selecionado.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- METAS -->
        {% if dados.metas %}
        <section id="metas" class="mb-5">
            <h3 class="mb-4"><i class="fas fa-bullseye"></i> Metas Financeiras</h3>
            <div class="row">
                {% for meta in dados.metas %}
                <div class="col-md-6 mb-3">
                    <div class="card meta-card">
                        <div class="card-body">
                            <h6 class="card-title">{{ meta.nome or 'Meta ' + meta.categoria_nome }}</h6>
                            <div class="meta-progress-container">
                                {% set progresso = (meta.valor_atual / meta.valor_limite * 100) if meta.valor_limite > 0
                                else 0 %}
                                <div class="progress mb-2">
                                    <div class="progress-bar {% if progresso >= 100 %}bg-danger{% elif progresso >= 80 %}bg-warning{% else %}bg-success{% endif %}"
                                        role="progressbar" style="width: {{ progresso if progresso <= 100 else 100 }}%">
                                        {{ "%.1f"|format(progresso) }}%
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">R$ {{ "%.2f"|format(meta.valor_atual or 0) }}</small>
                                    <small class="text-muted">R$ {{ "%.2f"|format(meta.valor_limite) }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const USER_ID = "{{ user_id|default(1)|int }}";
        const MES_ATUAL = "{{ mes|default(now.now().month)|int }}";
        const ANO_ATUAL = "{{ ano|default(now.now().year)|int }}";

        // Carregamento inicial dos gráficos
        document.addEventListener('DOMContentLoaded', function () {
            carregarGraficos();
        });

        // Função para carregar gráficos
        function carregarGraficos() {
            // Mostrar spinners
            document.querySelectorAll('.loading-spinner').forEach(el => el.style.display = 'block');

            fetch(`/api/graficos/${USER_ID}?mes=${MES_ATUAL}&ano=${ANO_ATUAL}`)
                .then(response => response.json())
                .then(data => {
                    // Esconder spinners
                    document.querySelectorAll('.loading-spinner').forEach(el => el.style.display = 'none');

                    // Renderizar gráficos
                    if (data.pizza && Object.keys(data.pizza).length > 0) {
                        Plotly.newPlot('grafico-pizza', data.pizza.data, data.pizza.layout, { responsive: true });
                    }

                    if (data.evolucao && Object.keys(data.evolucao).length > 0) {
                        Plotly.newPlot('grafico-evolucao', data.evolucao.data, data.evolucao.layout, { responsive: true });
                    }

                    if (data.barras && Object.keys(data.barras).length > 0) {
                        Plotly.newPlot('grafico-barras', data.barras.data, data.barras.layout, { responsive: true });
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar gráficos:', error);
                    // Esconder spinners em caso de erro
                    document.querySelectorAll('.loading-spinner').forEach(el => el.style.display = 'none');
                });
        }

        // Função para atualizar dados
        function atualizarDados() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('fa-spin');

            // Atualizar KPIs
            fetch(`/api/kpis/${USER_ID}?mes=${MES_ATUAL}&ano=${ANO_ATUAL}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('receita-total').textContent = `R$ ${data.receita_total.toFixed(2)}`;
                    document.getElementById('despesa-total').textContent = `R$ ${data.despesa_total.toFixed(2)}`;
                    document.getElementById('saldo-mes').textContent = `R$ ${data.saldo_mes.toFixed(2)}`;
                    document.getElementById('taxa-poupanca').textContent = `${data.taxa_poupanca.toFixed(1)}%`;

                    // Atualizar cor do saldo
                    const saldoElement = document.getElementById('saldo-mes');
                    saldoElement.className = data.saldo_mes >= 0 ? 'card-title text-success' : 'card-title text-danger';
                })
                .catch(error => console.error('Erro ao atualizar KPIs:', error));

            // Recarregar gráficos
            carregarGraficos();

            setTimeout(() => {
                refreshIcon.classList.remove('fa-spin');
            }, 1000);
        }

        // Função para filtrar transações
        function filtrarTransacoes(tipo) {
            const rows = document.querySelectorAll('.transacao-row');

            rows.forEach(row => {
                const tipoTransacao = row.getAttribute('data-tipo');
                if (tipo === 'todas' || tipoTransacao === tipo) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Atualizar botões ativos
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Responsividade dos gráficos
        window.addEventListener('resize', function () {
            Plotly.Plots.resize('grafico-pizza');
            Plotly.Plots.resize('grafico-evolucao');
            Plotly.Plots.resize('grafico-barras');
        });
    </script>
</body>

</html>